#!/usr/bin/make -f
# -*- makefile -*-

#export DH_VERBOSE=1

# For tests
export GDAL_DATA=$(shell gdal-config --datadir)
export PROJ_LIB=/usr/share/proj
export ICU_DATA=$(shell icu-config --icudatadir)

SZN_CAIRO_LIBS=/opt/szn/cairo/lib/x86_64-linux-gnu
SZN_FREETYPE_LIBS=/opt/szn/freetype/lib/x86_64-linux-gnu

SCONS_FLAGS= \
CXX=g++ \
CC=gcc \
BOOST_LIBS=/usr/lib/x86_64-linux-gnu \
FREETYPE_INCLUDES=/opt/szn/freetype/include/freetype2 \
FREETYPE_LIBS=$(SZN_FREETYPE_LIBS) \
CAIRO=True \
CAIRO_INCLUDES=/opt/szn/cairo/include \
CAIRO_LIBS=$(SZN_CAIRO_LIBS) \
DEMO=True \
SVG_RENDERER=True \
PGSQL2SQLITE=True \
SYSTEM_FONTS=/usr/share/fonts/truetype \
DESTDIR=$(CURDIR)/debian/tmp PREFIX=/usr

CFLAGS = -g

ifneq (,$(findstring stats_basic,$(DEB_BUILD_OPTIONS)))
	SCONS_FLAGS += ENABLE_STATS=True
endif

ifneq (,$(findstring stats_render,$(DEB_BUILD_OPTIONS)))
	SCONS_FLAGS += ENABLE_STATS_RENDER=True
endif

ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
	CFLAGS += -Og
endif

override_dh_auto_test:
ifeq (,$(findstring nocheck,$(DEB_BUILD_OPTIONS)))
	# The test suite passes only with specific library versions
	# but the output can be useful.
	make test || true
else
	echo "Tests disabled"
endif

CUSTOM_LDFLAGS=-Wl,-rpath=$(SZN_CAIRO_LIBS) -Wl,-rpath=$(SZN_FREETYPE_LIBS)

override_dh_auto_configure:
	./configure $(SCONS_FLAGS) CUSTOM_CXXFLAGS="$(CFLAGS)" \
        CUSTOM_LDFLAGS="$(CUSTOM_LDFLAGS)"
	dh_auto_configure

override_dh_prep:
	dh_prep -Xdebian/tmp

override_dh_install:
	JOBS=2 make install
	dh_install

override_dh_auto_clean:
	-make distclean
	rm -rf config.py.backup

%:
	dh $@
